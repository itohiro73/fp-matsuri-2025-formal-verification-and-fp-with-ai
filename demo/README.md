# 書店システム開発デモ - 形式手法による要件明確化

## 概要

このデモは、プレゼン「AIと共に進化する開発手法：形式手法と関数型プログラミングの可能性」で紹介されたアプローチを実践的に再現するものです。

自然言語で記述された曖昧な要件を形式手法（AlloyとTLA+）で分析し、隠れた問題点を洗い出すプロセスを段階的に実装していきます。

## 現在の進捗状況

### ✅ 完了済み: Phase 1 - 要件の形式化と問題発見

1. **自然言語要件の作成** (`requirements.md`)
   - 典型的な書店システムの要件を自然言語で記述
   - 実際のプロジェクトでよく見られる曖昧性を意図的に含める

2. **Alloy仕様による構造的モデリング** (`formal-specs/bookstore.als`)
   - エンティティ間の関係と制約を数学的に記述
   - 構造的な不整合や制約の矛盾を発見

3. **TLA+仕様による動的モデリング** (`formal-specs/bookstore.tla`)
   - システムの状態遷移と並行処理を時系列で記述
   - 競合状態やデッドロックの可能性を発見

4. **問題分析レポート** (`formal-specs/ambiguity-analysis.md`)
   - 発見された7つの主要な曖昧性を詳細に分析
   - 各問題の影響度と解決の優先度を評価

## 発見された主要な問題

### 🚨 重大な問題（システムの整合性に直結）

1. **在庫管理の競合状態**
   - 同時注文による在庫のマイナス化
   - Check-Then-Act パターンによる競合

2. **状態遷移の不整合**
   - 支払い失敗後の確定済み注文の扱い
   - キャンセル可能な状態の範囲が不明確

3. **並行処理制御の欠如**
   - 同一商品への同時アクセス制御なし
   - 原子性が保証されていない操作

### 📋 中程度の問題（ビジネスロジックの曖昧性）

4. **在庫復元のタイミング**
   - キャンセル時の在庫復元メカニズムが不明確
   - 他の待機注文への影響が未定義

5. **支払い処理との連携**
   - 支払いと注文確定のタイミング関係が曖昧

## ファイル構成

```
demo/
├── README.md                           # このファイル
├── requirements.md                     # 自然言語による初期要件
└── formal-specs/
    ├── bookstore.als                   # Alloy仕様（構造的モデリング）
    ├── bookstore.tla                   # TLA+仕様（動的モデリング）
    └── ambiguity-analysis.md           # 問題分析レポート
```

## 形式手法による価値の実証

### Before（自然言語要件のみ）
- ✅ 「在庫がある本のみ注文可能」→ 一見明確
- ✅ 「同時注文に対応」→ 要件として記載済み
- ✅ 「キャンセル時は在庫復元」→ 当然の機能

### After（形式手法による分析）
- 🚨 在庫1冊に2件の同時注文で在庫マイナス化
- 🚨 競合状態により不整合なデータ状態が発生
- 🚨 キャンセル処理中の新規注文で二重割り当て

**結果**: 実装前に7つの重大な問題を発見し、手戻りを防止

## 次の段階（予定）

### Phase 2: 明確化された仕様の作成
- [ ] 発見された問題に対するビジネスルールの明確化
- [ ] 改良されたAlloy/TLA+仕様の作成
- [ ] 制約の完全性検証

### Phase 3: 代数的データ型による型安全な実装
- [ ] Kotlinでの代数的データ型（ADT）によるドメインモデリング
- [ ] 型システムによる制約の実装レベルでの表現
- [ ] 不可能な状態を型で表現不可能にする設計

### Phase 4: プロパティベーステスト
- [ ] 形式仕様から導出されたプロパティのテスト実装
- [ ] 継続的な制約検証の自動化
- [ ] ラウンドトリップテストとメタモルフィックテスト

### Phase 5: AI駆動開発への統合
- [ ] 明確化された仕様をAIエージェントに提供
- [ ] 制約をガードレールとしたコード生成
- [ ] 形式手法によるシフトレフトアプローチの実証

## 学習ポイント

1. **形式手法の威力**: 自然言語では見落とされる問題を数学的に発見
2. **早期問題発見**: 実装前に重大な設計問題を特定
3. **曖昧性の可視化**: 「当然」と思われていた要件の曖昧性を明確化
4. **AI開発への応用**: 明確な制約がAIエージェントの品質向上に寄与

## 実行方法（将来の段階で追加予定）

現在は仕様書とモデルファイルのみです。実装段階では以下が追加される予定：

```bash
# 形式仕様の検証（Alloy Analyzer使用）
alloy bookstore.als

# TLA+モデル検査（TLC使用）
tlc bookstore.tla

# 実装とテスト（Kotlin + Property-based testing）
./gradlew test
```

---

**このデモの目的**: 形式手法と関数型プログラミングがAI駆動開発において、どのように品質向上とシフトレフトを実現するかを実践的に示すこと。 