# 書店システム要求仕様書（改良版）
## Phase 2 形式検証による曖昧性解決後の明確化された仕様

**文書バージョン**: 2.0  
**作成日**: 2025年6月14日  
**ステータス**: 形式検証済み・曖昧性解決済み

---

## 概要

本文書は、オンライン書店システムの要求仕様を定義します。この仕様は、TLA+およびAlloyによる形式検証を通じて発見された曖昧性を解決し、実装時の解釈の余地を排除した明確な要求として再定義されています。

## 1. 在庫管理要求

### 1.1 在庫チェックと予約（曖昧性解決済み）

**要求**: システムは注文受付時に在庫の確認と予約を**原子的操作**として実行しなければならない。

**詳細仕様**:
- 顧客が注文を送信した瞬間に、在庫の可用性チェックと在庫予約が同時に実行される
- この操作は分割不可能であり、他の注文処理と並行実行されない
- 在庫が不足している場合、注文は即座に拒否される
- 在庫が十分な場合、注文は「予約済み」状態となり、該当する数量が即座に予約在庫に移される

**解決された曖昧性**: 
- ❌ 元の仕様: "在庫のある本のみ注文可能" → いつ在庫をチェックするか不明
- ✅ 改良版: 注文受付時の原子的在庫チェック・予約操作

### 1.2 在庫保存則（新規追加）

**要求**: システムは在庫の保存則を常に維持しなければならない。

**詳細仕様**:
- 各書籍について: 物理在庫 + 予約在庫 = 総在庫数（定数）
- 予約在庫は物理在庫を超過してはならない
- すべての在庫数は非負整数でなければならない

## 2. 注文処理要求

### 2.1 注文状態遷移（曖昧性解決済み）

**要求**: 注文は以下の明確に定義された状態遷移に従わなければならない。

**状態定義**:
- **予約済み**: 在庫が予約され、支払い待ち
- **確認済み**: 支払いが完了し、発送準備中
- **発送済み**: 商品が発送完了
- **キャンセル済み**: 注文がキャンセルされ、在庫が復元済み

**許可される状態遷移**:
- 予約済み → 確認済み（支払い完了時）
- 予約済み → キャンセル済み（キャンセル時）
- 確認済み → 発送済み（発送時）

**禁止される状態遷移**:
- 確認済み → キャンセル済み（確認後のキャンセル不可）
- 発送済み → その他の状態（発送後の状態変更不可）

**解決された曖昧性**:
- ❌ 元の仕様: "保留中と確認済みの注文はキャンセル可能" → 確認済み後のキャンセル可否が不明
- ✅ 改良版: 確認済み後のキャンセルは不可

### 2.2 同時注文処理の排他制御（曖昧性解決済み）

**要求**: 同一書籍に対する注文処理は相互排他的に実行されなければならない。

**詳細仕様**:
- 同一書籍について、同時に「確認済み」状態になれる注文は最大1件
- 複数の「予約済み」注文は許可されるが、「確認済み」への遷移は順次実行
- 処理中の注文がある間、同一書籍の他の注文は待機状態となる

**解決された曖昧性**:
- ❌ 元の仕様: "同時注文の処理方法" → 競合状態の処理方法が不明
- ✅ 改良版: 明確な排他制御による順次処理

## 3. 支払い処理要求

### 3.1 支払い優先ポリシー（曖昧性解決済み）

**要求**: 商品発送は支払い完了を必須前提条件とする。

**詳細仕様**:
- 注文が「発送済み」状態になるためには、支払いが「完了」状態でなければならない
- 支払いが「失敗」状態の注文は自動的に「キャンセル済み」状態に遷移する
- 支払い失敗時、予約されていた在庫は即座に物理在庫に復元される

**解決された曖昧性**:
- ❌ 元の仕様: "支払い処理のタイミング" → 確認と支払いの順序が不明
- ✅ 改良版: 支払い完了が発送の必須前提条件

## 4. キャンセル処理要求

### 4.1 キャンセル可能条件（曖昧性解決済み）

**要求**: 注文のキャンセルは特定の状態でのみ許可される。

**詳細仕様**:
- キャンセル可能状態: 「予約済み」のみ
- キャンセル不可状態: 「確認済み」「発送済み」
- キャンセル実行時、予約在庫は即座に物理在庫に復元される
- キャンセル処理は原子的操作として実行される

**解決された曖昧性**:
- ❌ 元の仕様: "保留中と確認済みの注文はキャンセル可能" → 確認済み後のキャンセル可否が曖昧
- ✅ 改良版: 予約済み状態のみキャンセル可能

### 4.2 在庫復元処理（新規明確化）

**要求**: キャンセル時の在庫復元は即座に実行されなければならない。

**詳細仕様**:
- キャンセル処理と在庫復元は単一の原子的操作
- 復元される数量は元の注文数量と正確に一致
- 復元後、他の待機中注文が即座に処理可能となる

## 5. タイムアウト処理要求

### 5.1 予約タイムアウト（新規追加）

**要求**: 予約済み注文は一定時間後に自動的にタイムアウトしなければならない。

**詳細仕様**:
- 予約タイムアウト時間: 8時間（設定可能）
- タイムアウト時、注文は自動的に「キャンセル済み」状態に遷移
- タイムアウト処理時、予約在庫は自動的に物理在庫に復元
- タイムアウト処理は定期的なバックグラウンド処理として実行

**新規要求の理由**: 形式検証により、無期限の予約が在庫枯渇を引き起こす可能性を発見

## 6. システム制約

### 6.1 パフォーマンス制約

**要求**: システムは以下のパフォーマンス制約を満たさなければならない。

**詳細仕様**:
- 最大同時注文数: 設定可能（デフォルト: 1000件）
- 最大書籍在庫数: 設定可能（デフォルト: 10000冊）
- 注文処理応答時間: 3秒以内
- 在庫確認応答時間: 1秒以内

### 6.2 データ整合性制約

**要求**: システムは常にデータ整合性を維持しなければならない。

**詳細仕様**:
- 在庫数の整合性: 物理在庫 + 予約在庫 = 総在庫数
- 注文状態の整合性: 各注文は常に有効な状態にある
- 支払い状態の整合性: 発送済み注文の支払いは必ず完了状態

## 7. 形式検証による品質保証

### 7.1 検証済み特性

本仕様は以下の特性がTLA+およびAlloyによって形式的に検証済みです：

**安全性特性**:
- ✅ 在庫が負の値になることはない
- ✅ 予約在庫が物理在庫を超過することはない  
- ✅ 支払い未完了の注文が発送されることはない
- ✅ 同一書籍で複数の注文が同時に確認されることはない

**活性特性**:
- ✅ 有効な注文は最終的に処理される
- ✅ タイムアウトした予約は最終的に解放される

### 7.2 発見・解決された問題

形式検証により以下の重要な問題が発見・解決されました：

1. **競合状態**: 同時注文による在庫オーバーブッキング → 原子的操作で解決
2. **状態遷移の曖昧性**: 確認後キャンセルの可否 → 明確な状態遷移ルールで解決
3. **支払いタイミング**: 支払いと発送の順序 → 支払い優先ポリシーで解決
4. **在庫復元タイミング**: キャンセル時の在庫復元 → 即座復元ルールで解決
5. **リソースリーク**: 無期限予約による在庫枯渇 → タイムアウト機能で解決

## 8. 実装ガイドライン

### 8.1 推奨実装アプローチ

**データベース設計**:
- トランザクション分離レベル: SERIALIZABLE
- 在庫操作: 単一トランザクション内で実行
- 楽観的ロック: バージョン管理による競合検出

**アーキテクチャパターン**:
- イベントソーシング: 状態変更の完全な監査証跡
- CQRS: 読み取りと書き込みの分離
- 関数型プログラミング: 不変データ構造による安全性確保

### 8.2 テスト要求

**必須テストケース**:
- 同時注文による競合状態テスト
- 支払い失敗時の在庫復元テスト  
- タイムアウト処理の正確性テスト
- 状態遷移の制約違反テスト

---

## 付録: 元仕様との比較

| 項目 | 元仕様（曖昧） | 改良版仕様（明確） |
|------|----------------|-------------------|
| 在庫チェック | "在庫のある本のみ" | 注文時の原子的チェック・予約 |
| 同時注文 | 処理方法不明 | 排他制御による順次処理 |
| キャンセル | "保留中と確認済み可能" | 予約済みのみ可能 |
| 支払いタイミング | 不明確 | 発送前必須完了 |
| 在庫復元 | タイミング不明 | キャンセル時即座復元 |
| 予約期限 | 無期限 | 8時間タイムアウト |

**結論**: 形式手法により、6つの重要な曖昧性が特定・解決され、実装時の解釈の余地が完全に排除されました。 