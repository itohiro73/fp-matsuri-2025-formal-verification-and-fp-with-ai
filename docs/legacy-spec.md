# 経費申請システム仕様書（従来版）

## 概要

社内経費申請システムは、従業員が経費を申請し、適切な承認プロセスを経て処理するためのシステムです。

## 機能仕様

### 経費申請機能

従業員は以下の項目を入力して経費を申請できます：
- 申請者名
- 申請金額
- 申請タイプ（交通費、宿泊費、会議費、備品購入など）
- 説明

申請後、金額に応じて適切な承認者に回送されます。

### 承認機能

管理者は申請を確認し、承認または却下できます。承認は順序立てて行われる必要があります。

### ユーザー管理

システムには以下の役職があります：
- 一般従業員
- マネージャー
- 部長
- 経理部長

## 承認ルール

### 金額ベースの承認
- 10,000円以下：マネージャー承認
- 10,000円超～50,000円：マネージャー → 部長
- 50,000円超：マネージャー → 部長 → 経理部長

### 承認制約
- 申請者は自分の申請を承認できません
- 承認は階層順で行う必要があります
- 適切な権限を持つ人のみ承認可能です

## 状態管理

申請は以下の状態を持ちます：
- 下書き
- 申請済み
- 承認待ち
- 承認済み
- 却下

## エラー処理

システムエラーや不正な操作に対して適切に対応します。

## セキュリティ

ユーザー認証を行い、適切な権限チェックを実施します。

---

## 📋 意図的な曖昧さと不完全性の解説

**この仕様書は、従来の開発手法の問題点を実演するために、意図的に以下の曖昧さと不完全性を含んでいます。**

### 🔴 1. 状態遷移の曖昧性

**問題**: 
- 状態の名前が不統一（「承認待ち」vs「ManagerReview」）
- 状態間の遷移条件が不明確
- 例：「却下」から何の状態に戻るのか？「下書き」？「申請済み」？

**形式手法での解決**:
- TLA+による厳密な状態遷移定義
- 各遷移の前提条件・事後条件の明確化

### 🔴 2. 金額境界の不整合

**問題**:
- 「10,000円以下」と「10,000円超」の境界で、ちょうど10,000円の場合が不明
- 金額の型（整数？小数？）が未定義
- 通貨の扱い（税込み？税抜き？）が不明

**形式手法での解決**:
- Alloyによる数値制約の厳密な定義
- 境界値の数学的表現

### 🔴 3. 権限モデルの不完全性

**問題**:
- 「適切な権限を持つ人」が具体的に誰なのか不明
- 組織階層の表現方法が不明確
- 代理承認の扱いが未定義
- 休暇中の承認者の代替処理が不明

**形式手法での解決**:
- Alloyによる権限関係の形式的モデリング
- 制約条件の数学的記述

### 🔴 4. 時間制約の曖昧性

**問題**:
- 「適切に」「速やかに」といった主観的表現
- 承認期限の起点が不明（申請日？前承認者の承認日？）
- タイムアウト時の動作が不明
- 週末・祝日の扱いが未定義

**形式手法での解決**:
- TLA+による時間的制約の厳密な定義
- タイムアウト処理の状態遷移

### 🔴 5. エラー処理の抽象性

**問題**:
- 「適切に対応」が具体的に何をするのか不明
- エラーの分類（システムエラー vs ビジネスルール違反）が不明確
- 復旧手順が未定義
- ユーザーへのフィードバック内容が不明

**形式手法での解決**:
- Either型による型安全なエラーハンドリング
- エラー状態の明示的モデリング

### 🔴 6. 同期処理の問題

**問題**:
- 複数ユーザーが同時に同じ申請を操作した場合の動作が不明
- データの整合性保証が不明確
- 楽観ロック vs 悲観ロックの戦略が未定義

**形式手法での解決**:
- TLA+による並行処理の安全性証明
- 不変条件の維持保証

### 🔴 7. ビジネスルールの例外処理

**問題**:
- 緊急時の特別承認フローが未定義
- 金額変更時の再承認要否が不明
- 申請取り下げの条件が不明確
- 部署異動時の申請継続性が未定義

**形式手法での解決**:
- 例外フローの明示的な状態として定義
- 制約条件の完全性チェック

### 🔴 8. データ整合性の不備

**問題**:
- 申請者と承認者の関係性チェックが曖昧
- 削除された承認者の履歴申請の扱いが不明
- 承認履歴の改ざん防止策が未定義

**形式手法での解決**:
- Alloyによるデータ整合性制約の検証
- 不変条件の数学的証明

## 💡 従来手法 vs 形式手法の対比

| 問題領域 | 従来仕様（この文書） | 形式手法による改善 |
|----------|---------------------|-------------------|
| **状態管理** | 自然言語による曖昧な記述 | TLA+による厳密な状態遷移定義 |
| **制約条件** | 散文での説明 | Alloyによる数学的制約記述 |
| **検証** | 手動テストのみ | 自動モデル検査による網羅的検証 |
| **実装ガイド** | 解釈に依存 | 型定義と契約への機械的変換 |
| **保守性** | 仕様と実装の乖離リスク | 仕様からの自動生成による一貫性 |

この対比により、**形式手法がAI駆動開発における「枠組みの提供」と「コンテキストの最小化」にどう貢献するか**を実演します。